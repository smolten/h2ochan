{% if new %}
	{% set action = '?/new-board-bible' %}
{% else %}
	{% set action = '?/edit-bible/' ~ board.uri %}
{% endif %}

<form action="{{ action }}" method="post">
	<input type="hidden" name="token" value="{{ token }}">
	<input type="hidden" name="token_test_parse" value="{{ token_test_parse }}">
	<input type="hidden" name="token_board_status" value="{{ token_board_status }}">
	<input type="hidden" name="token_post_threads" value="{{ token_post_threads }}">
	<input type="hidden" name="token_post_replies" value="{{ token_post_replies }}">
	<input type="hidden" name="token_post_book" value="{{ token_post_book }}">
	<table>

		<tr>
	            <th>{% trans 'Bible Book' %}</th>
	            <td>
	                {% if not bible_index %}
	                    Index not found at {{ bible_path_index }}
	                {% elseif new %}
	                    <select name="bible_book" id="bible_book">
	                        <option value="">-- Select a Book --</option>
	                        {% for book in bible_index %}
	                            <option
	                                value="{{ book.short|e('html_attr') }}"
	                                data-uri="{{ book.osisID|e('html_attr') }}"
	                                data-title="{{ book.short|e('html_attr') }}"
	                                data-subtitle="{{ book.text|e('html_attr') }}"
	                            >
	                                {{ book.short }}
	                            </option>
	                        {% endfor %}
	                    </select>
			{% else %}
			    <span id="bible_book_preset" name="bible_book_preset">TITLE</span>
	                {% endif %}
	            </td>
	        </tr>
<tr>
    <th>DEBUG_Select</th>
    <td>
	Chapter:
        <select id="debug_chapter" name="debug_chapter">
            {% for i in range(1, 100) %}
                <option value="{{ i }}">{{ i }}</option>
            {% endfor %}
        </select>
	Verse:
        <select id="debug_verse" name="debug_verse">
            {% for i in range(1, 100) %}
                <option value="{{ i }}">{{ i }}</option>
            {% endfor %}
        </select>
	Num_verses:
	<select id="debug_count" name="debug_count">
	    <option value="150">150</option>
	    {% for c in range(1, 100) %}
		<option value="{{ c }}">{{ c }}</option>
	    {% endfor %}
	</select>
        <button type="button" name="debug_parse" id="debug_parse">Test Parse</button>
    </td>
</tr>

<tr>
    <th>DEBUG_Output</th>
    <td>
	<pre>
{{ debug_output|default('Select a book, chapter, and verse, then press Test Parse.') }}
        </pre>
    </td>
</tr>
		<tr>
			<th>{% trans 'URI' %}</th>
			<td>
				{% if not new %}
					<span name="uri_preset" id="uri_preset">{{ config.board_abbreviation|sprintf(board.uri) }}</span>
				{% else %}
					/<input size="10" maxlength="255" type="text" name="uri" id="uri" autocomplete="off">/
				{% endif %}
			</td>
		</tr>
		<tr>
			<th>{% trans 'Title' %}</th>
			<td>
				<input size="25" type="text" name="title" id="title" value="{{ board.title|e }}" autocomplete="off">
			</td>
		</tr>
		<tr>
			<th>{% trans 'Subtitle' %}</th>
			<td>
				<input size="25" type="text" name="subtitle" id="subtitle" value="{{ board.subtitle|e }}" autocomplete="off">
			</td>
		</tr>
		{% if not new %}
		<tr>
			<th>Status</th>
			<td>
				<span name="posts_status" id="posts_status">NaN threads. NaN total posts.</span>
			</td>
		</tr>
		<tr>
			<th>ACTION</th>
			<td>
			<button type="button" name="get_status" id="get_status">Get Status</button>
			<button type="button" name="do_post_book" id="do_post_book">Post Book</button><br>
			<button type="button" name="do_post_threads" id="do_post_threads">Post Chapter Threads</button>
        		<button type="button" name="do_post_replies" id="do_post_replies">Post Verse Replies</button>
			</td>
		</tr>		
		{% endif %}
	</table>
	
	<ul style="padding:0;text-align:center;list-style:none">
	{% if new %}
            <li><input type="submit" value="{% trans 'Create board' %}"></li>
	{% endif %}
	</ul>
</form>

{% if not new %}
<script>
    /*Pass PHP/Twig array into JS (only for Edit page)*/
    var bible_index = {{ bible_index|json_encode|raw }};
</script>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    var bibleTitleChoose = document.getElementById('bible_book');
    var bibleTitlePreset = document.getElementById('bible_book_preset');
    var title = document.getElementById('title');
    var uri = document.getElementById('uri');
    var uriPreset = document.getElementById('uri_preset');
    var uriValue = '';
    if (uri)  {
	uriValue = uri.value;
	console.log("set uri from editbox: " + uriValue);
    }
    else {
	uriValue = uriPreset.textContent.replace(/^\/+|\/+$/g, '');
	console.log("set uri from preset: " + uriValue);
    }

    if (bibleTitlePreset) {
	var book = bible_index.find(book => book.osisID === uriValue) || null;
        if(book) {
            bibleTitlePreset.textContent = book.short;
        } else {
	    bibleTitlePreset.textContent = 'NO TITLE FOUND: ' + uriValue;
	}
    }
    
    var output = document.querySelector('pre');
    output.dataset.default = output.textContent;

    if (bibleTitleChoose) {
	var subtitle = document.getElementById('subtitle');

	bibleTitleChoose.addEventListener('change', function() {
	        var opt = bibleTitleChoose.options[bibleTitleChoose.selectedIndex];
	        uri.value = opt.dataset.uri || '';
		uriValue = uri.value;
	        title.value = opt.dataset.title || '';
	        subtitle.value = opt.dataset.subtitle || '';
		output.textContent = output.dataset.default;
    	});
    }

    var chap = document.getElementById('debug_chapter');
    var verse = document.getElementById('debug_verse');
    var count = document.getElementById('debug_count');
    var testparse = document.getElementById('debug_parse');
    testparse.addEventListener('click', function() {

	    if (!uriValue || uriValue.length === 0) {
	        output.textContent = 'Error: Choose a Book';
		return;
	    }

            var tokenInput = document.querySelector('input[name="token_test_parse"]');
            var params = new URLSearchParams();
            params.append('uri', uriValue);
	    params.append('chapter', chap.value);
            params.append('verse', verse.value);
            params.append('count', count.value);
	    params.append('token', tokenInput.value);

	    fetch('/mod.php?/bible-parse-test', {
    		method: 'POST',
    		headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    		body: params.toString(),
		credentials: 'same-origin'
	    })
            .then(response => response.text())
            .then(text => {
                output.textContent = text || '(no response)';
            })
            .catch(err => {
                output.textContent = 'Error: ' + err;
            });
    });

    var status = document.getElementById('posts_status');
    document.getElementById('get_status').addEventListener('click', board_status);
    document.getElementById('do_post_book').addEventListener('click', do_book);
    document.getElementById('do_post_threads').addEventListener('click', do_threads);
    document.getElementById('do_post_replies').addEventListener('click', do_replies);
    board_status();
    function board_status() {	
        var tokenStatus = document.querySelector('input[name="token_board_status"]');
        var params = new URLSearchParams();
        params.append('uri', uriValue);
        params.append('token', tokenStatus.value);

        fetch('/mod.php?/board-status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params.toString(),
            credentials: 'same-origin'
        })
        .then(response => response.text())
        .then(text => {
            status.textContent = text || '(no response)';
        })
        .catch(err => {
            status.textContent = 'Error: ' + err;
        });
    };
    function do_book() {
        var tokenBook = document.querySelector('input[name="token_post_book"]');
	var params = new URLSearchParams();
	params.append('uri', uriValue);
	params.append('token', tokenBook.value);
	console.log("Posting book of URI:", uriValue);

	fetch('/mod.php?/bible-post-book', {
	    method: 'POST',
	    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
	    body: params.toString(),
	    credentials: 'same-origin'
	})
	.then(() => board_status())
	.catch(err => {
	    status.textContent = 'Error: ' + err;
	});
    };
    function do_threads() {
    	var tokenThreads = document.querySelector('input[name="token_post_threads"]');
	var params = new URLSearchParams();
	params.append('uri', uriValue);
	params.append('token', tokenThreads.value);
	console.log("Posting threads for URI:", uriValue, "token:", tokenThreads.value);

	fetch('/mod.php?/bible-post-threads', {
	    method: 'POST',
	    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
	    body: params.toString(),
	    credentials: 'same-origin'
	})
	.then(() => board_status())
	.catch(err => {
	    status.textContent = 'Error: ' + err;
	});
    };
    function do_replies() {
    	var tokenReplies = document.querySelector('input[name="token_post_replies"]');
	var params = new URLSearchParams();
	params.append('uri', uriValue);
	params.append('token', tokenReplies.value);

	fetch('/mod.php?/bible-post-replies', {
	    method: 'POST',
	    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
	    body: params.toString(),
	    credentials: 'same-origin'
	})
	.then(() => board_status())
	.catch(err => {
	    status.textContent = 'Error: ' + err;
	});
    };
});
</script>
