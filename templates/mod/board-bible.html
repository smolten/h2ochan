{% if new %}
	{% set action = '?/new-board-bible' %}
{% else %}
	{% set action = '?/edit-bible/' ~ board.uri %}
{% endif %}

<form action="{{ action }}" method="post">
	<input type="hidden" name="token" value="{{ token }}">
	<input type="hidden" name="token_test_parse" value="{{ token_test_parse }}">
	<input type="hidden" name="token_board_status" value="{{ token_board_status }}">
	<input type="hidden" name="token_post_book" value="{{ token_post_book }}">
	<input type="hidden" name="token_delete_book" value="{{ token_delete_book }}">
	<table>
		<tr>
	            <th>{% trans 'Bible Book' %}</th>
	            <td>
	                {% if not bible_index %}
	                    Index not found at {{ bible_path_index }}
	                {% elseif new %}
	                    <select name="bible_book" id="bible_book">
	                        <option value="">-- Select a Book --</option>
	                        {% for book in bible_index %}
	                            <option
	                                value="{{ book.short|e('html_attr') }}"
	                                data-uri="{{ book.osisID|e('html_attr') }}"
	                                data-title="{{ book.short|e('html_attr') }}"
	                                data-subtitle="{{ book.text|e('html_attr') }}"
	                                data-exists="{{ book.exists ? '1' : '0' }}"
	                            >
	                                {{ book.short }}
	                            </option>
	                        {% endfor %}
	                    </select>
			{% else %}
			    <span id="bible_book_preset" name="bible_book_preset">TITLE</span>
	                {% endif %}
		    {% if new %}
		    &nbsp;&nbsp;
                    <button type="button" id="next_chapter">&gt;</button>
		    &nbsp;&nbsp;
		    <label><input type="checkbox" id="include_existing_boards"> Include Existing Boards</label>
		    {% else %}
		    &nbsp;&nbsp;
                    <button type="button" id="next_book_btn">&gt;</button>
		    {% endif %}
	            </td>
	        </tr>
<tr>
    <th>DEBUG_Select</th>
    <td>
	Chapter:
        <select id="debug_chapter" name="debug_chapter">
            {% for i in range(1, 100) %}
                <option value="{{ i }}">{{ i }}</option>
            {% endfor %}
        </select>
	Verse:
        <select id="debug_verse" name="debug_verse">
            {% for i in range(1, 100) %}
                <option value="{{ i }}">{{ i }}</option>
            {% endfor %}
        </select>
	Num_verses:
	<select id="debug_count" name="debug_count">
	    <option value="150">150</option>
	    {% for c in range(1, 100) %}
		<option value="{{ c }}">{{ c }}</option>
	    {% endfor %}
	</select>
        <button type="button" name="debug_parse" id="debug_parse">Test Parse</button>
    </td>
</tr>

<tr>
    <th>DEBUG_Output</th>
    <td>
	<pre>
{{ debug_output|default('Select a book, chapter, and verse, then press Test Parse.') }}
        </pre>
    </td>
</tr>
<tr>
    <th>CREATE_ALL</th>
    <td><pre>
	POST BOOK ON BOARD CREATE:
	<input type="checkbox" name="bible_create_all" id="bible_create_all" {% if config.bible_create_all %}checked{% endif %}>
    </td></pre>
</tr>
		{% if not new %}
		<tr>
		    <th>REPOST_ALL</th>
		    <td><pre>
	REPOST ALL BIBLE BOOKS:
	<input type="checkbox" name="bible_repost_all" id="bible_repost_all">
	Delay (seconds): <input type="number" name="bible_repost_delay" id="bible_repost_delay" value="2" min="0.1" step="0.1" style="width: 60px;">
		    </td></pre>
		</tr>
		{% endif %}
		<tr>
			<th>{% trans 'URI' %}</th>
			<td>
				{% if not new %}
					<a href="?/{{ config.board_path|sprintf(board.uri) }}{{ config.file_index }}">
					<span name="uri_preset" id="uri_preset">{{ config.board_abbreviation|sprintf(board.uri) }}</span>
					</a>
				{% else %}
					/<input size="10" maxlength="255" type="text" name="uri" id="uri" autocomplete="off">/
				{% endif %}
			</td>
		</tr>
		<tr>
			<th>{% trans 'Title' %}</th>
			<td>
				<input size="25" type="text" name="title" id="title" value="{{ board.title|e }}" autocomplete="off">
			</td>
		</tr>
		<tr>
			<th>{% trans 'Subtitle' %}</th>
			<td>
				<input size="25" type="text" name="subtitle" id="subtitle" value="{{ board.subtitle|e }}" autocomplete="off">
			</td>
		</tr>
		{% if not new %}
		<tr>
			<th>Status</th>
			<td>
				<span name="posts_status" id="posts_status">NaN threads. NaN total posts.</span>
			</td>
		</tr>
		<tr>
			<th>ACTION</th>
			<td>
			<button type="button" name="get_status" id="get_status">Get Status</button>
			<button type="button" name="do_post_book" id="do_post_book">Post Book</button>
			<button type="button" onclick="history.back()">(Webpage Back)</button>                        <br>
			<button type="button" name="do_delete_book" id="do_delete_book">Delete Book</button>
			</td>
		</tr>		
		{% endif %}
	</table>
	
	<ul style="padding:0;text-align:center;list-style:none">
	{% if new %}
            <li><input type="submit" value="{% trans 'Create board' %}"></li>
	{% endif %}
	</ul>
</form>

{% if not new %}
<script>
    /*Pass PHP/Twig array into JS (only for Edit page)*/
    var bible_index = {{ bible_index|json_encode|raw }};
    var bible_create_all = {%if config.bible_create_all%}true{%else%}false{%endif%};
</script>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    var bibleTitleChoose = document.getElementById('bible_book');
    var bibleTitlePreset = document.getElementById('bible_book_preset');
    var title = document.getElementById('title');
    var uri = document.getElementById('uri');
    var uriPreset = document.getElementById('uri_preset');
    var uriValue = '';
    if (uri)  {
	uriValue = uri.value;
	console.log("set uri from editbox: " + uriValue);
    }
    else {
	uriValue = uriPreset.textContent.replace(/^\/+|\/+$/g, '');
	console.log("set uri from preset: " + uriValue);
    }

    if (bibleTitlePreset) {
	var book = bible_index.find(book => book.osisID === uriValue) || null;
        if(book) {
            bibleTitlePreset.textContent = book.short;
        } else {
	    bibleTitlePreset.textContent = 'NO TITLE FOUND: ' + uriValue;
	}
    }
    
    var output = document.querySelector('pre');
    output.dataset.default = output.textContent;

    if (bibleTitleChoose) {
	var subtitle = document.getElementById('subtitle');

	bibleTitleChoose.addEventListener('change', function() {
	        var opt = bibleTitleChoose.options[bibleTitleChoose.selectedIndex];
	        if (uri) uri.value = opt.dataset.uri || '';
		if (uri) uriValue = uri.value;
	        if (title) title.value = opt.dataset.title || '';
	        if (subtitle) subtitle.value = opt.dataset.subtitle || '';
		if (output) output.textContent = output.dataset.default;
    	});

	var includeExistingCheckbox = document.getElementById('include_existing_boards');
	if (includeExistingCheckbox) {
	    function filterBooks() {
		var includeExisting = includeExistingCheckbox.checked;
		Array.from(bibleTitleChoose.options).forEach(function(option) {
		    if (option.value === '') {
			option.style.display = '';
		    } else {
			var exists = option.getAttribute('data-exists') === '1';
			option.style.display = (includeExisting || !exists) ? '' : 'none';
		    }
		});
	    }
	    includeExistingCheckbox.addEventListener('change', filterBooks);
	    filterBooks();
	}
    }

    var chap = document.getElementById('debug_chapter');
    var verse = document.getElementById('debug_verse');
    var count = document.getElementById('debug_count');
    var testparse = document.getElementById('debug_parse');
    testparse.addEventListener('click', function() {

	    if (!uriValue || uriValue.length === 0) {
	        output.textContent = 'Error: Choose a Book';
		return;
	    }

            var tokenInput = document.querySelector('input[name="token_test_parse"]');
            var params = new URLSearchParams();
            params.append('uri', uriValue);
	    params.append('chapter', chap.value);
            params.append('verse', verse.value);
            params.append('count', count.value);
	    params.append('token', tokenInput.value);

	    fetch('/mod.php?/bible-parse-test', {
    		method: 'POST',
    		headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    		body: params.toString(),
		credentials: 'same-origin'
	    })
            .then(response => response.text())
            .then(text => {
                output.textContent = text || '(no response)';
            })
            .catch(err => {
                output.textContent = 'Error: ' + err;
            });
    });

    var repostAllCheckbox = document.getElementById('bible_repost_all');
    var repostDelayInput = document.getElementById('bible_repost_delay');
    var postBookBtn = document.getElementById('do_post_book');
    if (repostAllCheckbox && postBookBtn) {
	var referrer = document.referrer;
	var currentURL = window.location.href;
	var isSamePage = referrer === currentURL;
	var fromEditPage = referrer.includes('/mod.php?/edit_bible/') && !isSamePage;

	if (localStorage.getItem('bible_repost_all') === 'true' && fromEditPage) {
	    repostAllCheckbox.checked = true;
	    postBookBtn.textContent = '(re)Post Book';
	} else {
	    repostAllCheckbox.checked = false;
	    localStorage.removeItem('bible_repost_all');
	    postBookBtn.textContent = 'Post Book';
	}
	repostAllCheckbox.addEventListener('change', function() {
	    if (this.checked) {
		localStorage.setItem('bible_repost_all', 'true');
		postBookBtn.textContent = '(re)Post Book';
	    } else {
		localStorage.removeItem('bible_repost_all');
		postBookBtn.textContent = 'Post Book';
	    }
	});

	if (repostAllCheckbox.checked && fromEditPage) {
	    setTimeout(function() {
		postBookBtn.click();
	    }, 100);
	}
    }

    var status = document.getElementById('posts_status');
    var nextChapter = document.getElementById('next_chapter');
    if(status) {
        document.getElementById('get_status').addEventListener('click', board_status);	/*doesn't exist on NEW page*/
        document.getElementById('do_post_book').addEventListener('click', do_book);
        document.getElementById('do_delete_book').addEventListener('click', do_delete_book);

	if(bible_create_all) {
	    do_book();
	} else
	    board_status();
    }
    if (nextChapter && bibleTitleChoose) {
	nextChapter.addEventListener('click',  () => {
    	    let currentIndex = bibleTitleChoose.selectedIndex;
    	    let nextIndex = currentIndex + 1;
    	    while (nextIndex < bibleTitleChoose.options.length) {
    	        let option = bibleTitleChoose.options[nextIndex];
    	        if (option.style.display !== 'none') {
    	            bibleTitleChoose.selectedIndex = nextIndex;
    	            const event = new Event('change', { bubbles: true });
                    bibleTitleChoose.dispatchEvent(event);
                    console.log('Selected book:', bibleTitleChoose.value);
                    break;
    	        }
    	        nextIndex++;
    	    }
	});
    }
    function board_status() {
        var tokenStatus = document.querySelector('input[name="token_board_status"]');
        var params = new URLSearchParams();
        params.append('uri', uriValue);
        params.append('token', tokenStatus.value);

        fetch('/mod.php?/board-status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params.toString(),
            credentials: 'same-origin'
        })
        .then(response => response.text())
        .then(text => {
            if (text && (text.includes('ERROR:') || text.includes('Error:'))) {
                status.textContent = text;
                status.style.color = 'red';
            } else {
                status.textContent = text || '(no response)';
                status.style.color = '';
            }
        })
        .catch(err => {
            status.textContent = 'ERROR: ' + err;
            status.style.color = 'red';
        });
    };
    function do_book() {
	if (repostAllCheckbox && repostAllCheckbox.checked) {
	    do_repost_sequence();
	} else {
	    do_post_only();
	}
    }
    function do_post_only() {
	status.textContent = "Writing Book....";
        var tokenBook = document.querySelector('input[name="token_post_book"]');
	var params = new URLSearchParams();
	params.append('uri', uriValue);
	params.append('token', tokenBook.value);

	fetch('/mod.php?/bible-post-book', {
	    method: 'POST',
	    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
	    body: params.toString(),
	    credentials: 'same-origin'
	})
	.then(response => response.text())
	.then(text => {
	    if (text && text.includes('ERROR')) {
		status.textContent = text;
	    } else {
		board_status();
	    }
	})
	.catch(err => {
	    status.textContent = 'Error: ' + err;
	});
    }
    function do_repost_sequence() {
	if (!repostAllCheckbox.checked) {
	    status.textContent = 'REPOST stopped (unchecked)';
	    return;
	}
	status.textContent = "REPOST: Deleting...";
	var tokenDel = document.querySelector('input[name="token_delete_book"]');
	var delParams = new URLSearchParams();
	delParams.append('uri', uriValue);
	delParams.append('token', tokenDel.value);
	fetch('/mod.php?/bible-delete-book', {
	    method: 'POST',
	    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
	    body: delParams.toString(),
	    credentials: 'same-origin'
	})
	.then(response => response.text())
	.then(delText => {
	    if (delText.includes('ERROR')) {
		status.textContent = 'STOPPED: ' + delText;
		return Promise.reject('fail');
	    }
	    status.textContent = "REPOST: Posting...";
	    var tokenBook = document.querySelector('input[name="token_post_book"]');
	    var postParams = new URLSearchParams();
	    postParams.append('uri', uriValue);
	    postParams.append('token', tokenBook.value);
	    return fetch('/mod.php?/bible-post-book', {
		method: 'POST',
		headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
		body: postParams.toString(),
		credentials: 'same-origin'
	    });
	})
	.then(response => response.text())
	.then(postText => {
	    if (postText && postText.includes('ERROR')) {
		status.textContent = 'STOPPED: ' + postText;
		return Promise.reject('fail');
	    }
	    status.textContent = "REPOST: Fetching status...";
	    var tokenStatus = document.querySelector('input[name="token_board_status"]');
	    var statusParams = new URLSearchParams();
	    statusParams.append('uri', uriValue);
	    statusParams.append('token', tokenStatus.value);
	    return fetch('/mod.php?/board-status', {
		method: 'POST',
		headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
		body: statusParams.toString(),
		credentials: 'same-origin'
	    });
	})
	.then(response => response.text())
	.then(statusText => {
	    var delaySeconds = parseFloat(repostDelayInput.value) || 2;
	    var delayMs = Math.max(100, delaySeconds * 1000);
	    status.textContent = "REPOST: Done. " + statusText + " Next in " + delaySeconds + "s...";
	    setTimeout(() => {
		if (!repostAllCheckbox.checked) {
		    status.textContent = 'REPOST stopped (unchecked)';
		    return;
		}
		var nextURI = getNextBibleBookURI(uriValue);
		if (nextURI !== uriValue) {
		    window.location.href = '/mod.php?/edit_bible/' + nextURI;
		} else {
		    status.textContent = 'REPOST COMPLETE!';
		    localStorage.removeItem('bible_repost_all');
		    repostAllCheckbox.checked = false;
		}
	    }, delayMs);
	})
	.catch(err => {
	    if (err !== 'fail') {
		status.textContent = 'ERROR: ' + err;
	    }
	});
    }
    function do_delete_book() {
	status.textContent = "Deleting Book....";
	status.style.color = '';
	var tokenDelete = document.querySelector('input[name="token_delete_book"]');
	var params = new URLSearchParams();
	params.append('uri', uriValue);
	params.append('token', tokenDelete.value);
	console.log("Deleting book for URI:", uriValue);

	fetch('/mod.php?/bible-delete-book', {
	    method: 'POST',
	    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
	    body: params.toString(),
	    credentials: 'same-origin'
	})
	.then(response => response.text())
	.then(text => {
	    if (text && (text.includes('ERROR:') || text.includes('Error:'))) {
		status.textContent = text;
		status.style.color = 'red';
	    } else {
		status.textContent = text || '(no response)';
		status.style.color = '';
	    }
	})
	.catch(err => {
	    status.textContent = 'ERROR: ' + err;
	    status.style.color = 'red';
	});
    };

    var nextBookBtn = document.getElementById('next_book_btn');
    if (nextBookBtn) {
	nextBookBtn.addEventListener('click', function() {
	    var nextURI = getNextBibleBookURI(uriValue);
	    if (nextURI !== uriValue) {
		window.location.href = '/mod.php?/edit_bible/' + nextURI;
	    }
	});
    }

    function getNextBibleBookURI(currentURI) {
	if (typeof bible_index === 'undefined') {
	    alert('Bible index not loaded');
	    return currentURI;
	}
	var currentIndex = -1;
	for (var i = 0; i < bible_index.length; i++) {
	    if (bible_index[i].osisID === currentURI) {
		currentIndex = i;
		break;
	    }
	}
	if (currentIndex === -1) {
	    alert('Current book not found in index');
	    return currentURI;
	}
	if (currentIndex >= bible_index.length - 1) {
	    alert('Done! This is the last book (Revelation).');
	    return currentURI;
	}
	return bible_index[currentIndex + 1].osisID;
    }
});
</script>
